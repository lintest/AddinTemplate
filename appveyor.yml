version: 0.3.2.{build}

branches:
  only:
    - develop

skip_branch_with_pr: true

image:
  - Visual Studio 2019
  - Ubuntu1804

configuration:
  - Release

platform:
  - x64

install:
  - sh: sudo dpkg --add-architecture i386
  - sh: sudo apt -qq update
  - sh: sudo apt -qq -y install uuid-dev
  - sh: sudo apt -qq -y install gcc-multilib g++-multilib

init:
  - cmd: cmake --version
  - cmd: msbuild /version
  - cmd: echo.

before_build:
  - cmd: echo %APPVEYOR_BUILD_VERSION% > "version.txt"
  - sh: echo ${APPVEYOR_BUILD_VERSION} > "version.txt"
  - sh: echo "#define VERSION_FULL " ${APPVEYOR_BUILD_VERSION} > "version.h"

build_script:
  - cmd: Powershell.exe -File manifest.ps1 -Project NativeAddIn -Version %APPVEYOR_BUILD_VERSION%

  - mkdir build32
  - cd build32
  - sh: cmake -D CMAKE_BUILD_TYPE:STRING=Release -D TARGET_PLATFORM_32:BOOL=ON --build ..
  - cmd: cmake .. -A Win32 -DMySuffix2=32
  - cmake --build . --config Release
  - cd ..

  - mkdir build64
  - cd build64
  - sh: cmake -D CMAKE_BUILD_TYPE:STRING=Release -D TARGET_PLATFORM_32:BOOL=OFF --build ..
  - cmd: cmake .. -A x64 -DMySuffix2=64
  - cmake --build . --config Release
  - cd ..

  - cmd: copy bin\Release\libNativeAddInWin??.dll .
  - sh: cp bin/libNativeAddInLin??.so .

after_build:
  - cmd: 7z a NativeAddIn.zip libNativeAddInWin??.dll manifest.xml version.txt version.h
  - sh: 7z a NativeAddIn.zip libNativeAddInLin??.so version.txt version.h

artifacts:
  - path: NativeAddIn.zip
    name: NativeAddIn
